<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ARM64体系结构编程与实践 | zain&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="第1章 ARM64体系结构基础 ARMv8体系结构处理器包含31个通用寄存器 AArch64执行状态包含·4个异常等级，EL0~EL3，用户态、内">
<meta name="author" content="
&nbsp;Zain">
<link rel="canonical" href="https://liuz0123.gitee.io/zain/posts/tech/arm64%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/">
<link crossorigin="anonymous" href="/zain/assets/css/stylesheet.6bbe4903eaf247f5c3db656a51fd7b09d982ab42029edfdc123f359e2748dc03.css" integrity="sha256-a75JA&#43;ryR/XD22VqUf17CdmCq0ICnt/cEj81nidI3AM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/zain/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="apple-touch-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="mask-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="ARM64体系结构编程与实践" />
<meta property="og:description" content="第1章 ARM64体系结构基础 ARMv8体系结构处理器包含31个通用寄存器 AArch64执行状态包含·4个异常等级，EL0~EL3，用户态、内" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liuz0123.gitee.io/zain/posts/tech/arm64%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-12T00:21:58&#43;08:00" />
<meta property="article:modified_time" content="2022-07-12T00:21:58&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ARM64体系结构编程与实践"/>
<meta name="twitter:description" content="第1章 ARM64体系结构基础 ARMv8体系结构处理器包含31个通用寄存器 AArch64执行状态包含·4个异常等级，EL0~EL3，用户态、内"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚文章",
      "item": "https://liuz0123.gitee.io/zain/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "👨🏻‍💻 技术",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ARM64体系结构编程与实践",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/arm64%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ARM64体系结构编程与实践",
  "name": "ARM64体系结构编程与实践",
  "description": "第1章 ARM64体系结构基础 ARMv8体系结构处理器包含31个通用寄存器 AArch64执行状态包含·4个异常等级，EL0~EL3，用户态、内",
  "keywords": [
    ""
  ],
  "articleBody": "第1章 ARM64体系结构基础 ARMv8体系结构处理器包含31个通用寄存器 AArch64执行状态包含·4个异常等级，EL0~EL3，用户态、内核态、虚拟机、安全态 PSTATE寄存器中NZCV标志：负零进溢 PSTATE寄存器DAIF异常掩码标志位 1.1 ARM简介 ARM体系结构是一种硬件规范，主要约定指令集、芯片内部体系结构 ARMv8体系结构处理器IP Cortex-A53、Cortex-A55、Cortex-A72、Cortex-A77 1.2 ARMv8体系结构基础知识 1.2.1 ARMv8体系结构 ARMv8是64位处理器指令集和体系结构 64位虚拟地址空间，32位仅支持4GB 31个64位宽通用寄存器 支持16KB和64Kb页面，降低TLB命中率 异常处理模型EL0~EL3 加载-获取指令(Load-Acquire Instruction)，存储-释放指令(Store-Release Instruction) 1.2.2 ARMv8处理器内核 Cortex-A53 Cortex-A57 Cortex-A72 1.2.3 ARMv8体系结构基本概念 ARMv8体系结构基本概念和定义 处理机PE(Processing Element):处理器处理事务过程抽象 执行状态(execution state):处理器运行时环境，包括寄存器位宽、支持指令集、异常模型、内存管理以及编程模型 ARMv8两个执行状态\nAArch64：64位执行状态\n31个通用寄存器 64位程序计数(PC)指针寄存器、栈指针(Stack Pointer SP)寄存器及异常链接寄存器(Exception Link Register ELR) A64指令集 ARMv8异常模型，4个异常等级，即EL0~EL3 64位内存模型 一组处理器状态(PSTATE)保存PE状态 AArch32: 32位执行状态\nAArch64状态，部分系统寄存器在不同异常等级提供不同变种寄存器\n\u003cregister_name\u003e_ELx // x: 0 1 2 3 1.2.4 A64指令集 ARMv8体系结构64位指令集：处理64位宽寄存器和数据并使用64位指针访问内存\n1.2.5 ARMv8处理器执行状态 AArch64状态异常等级(exception level)确定处理器当前运行的特权级别\nEL0:用户特权 EL1：系统特权，操作系统内核，系统使能虚拟化扩展，运行虚拟操作系统内核 EL2：运行虚拟化扩展的虚拟监控程序(hypervisor) EL3：运行安全世界中安全监控器(secure monitor) 1.2.6 ARMv8数据宽度 字节(byte)：8位 半字(halfword)：16位 字(word)：32位 双字(doubleword)：64位 四字(quadword)：128位 1.3 ARMv8寄存器 1.3.1 通用寄存器 AArch64执行状态支持31个64位通用寄存器，X0~X30寄存器，AArch32状态支持16个32位通用寄存器 AArch64状态下，X表示64位通用寄存器，W表示低32位的数据\n1.3.2 处理器状态 AArch64体系结构使用PSTATE寄存器表示当前处理器状态\n分　类 字　段 描　述 描　述 条件标志位 N 负数标志位。 在结果是有符号的二进制补码的情况下，如果结果为负数，则N=1；如果结果为非负数，则N=0 Z 0标志位。如果结果为0，则Z=1；如果结果不为0，则Z=0 C 进位标志位。当发生无符号数溢出时，C=1。其他情况下，C=0 V 有符号数溢出标志位。\n　对于加/减法指令，在操作数和结果是有符号的整数时，如果发生溢出，则V=1；如果未发生溢出，则V=0。\n　对于其他指令，V通常不发生变化 执行状态控制 SS 软件单步。该位为1，说明在异常处理中使能了软件单步功能 IL 不合法的异常状态 nRW 当前执行状态 　0：处于AArch64状态 　1：处于AArch32状态 执行状态控制 EL 当前异常等级 　0：表示EL0\n　1：表示EL1\n　2：表示EL2\n　3：表示EL3 SP 选择SP寄存器。当运行在EL0时，处理器选择EL0的SP寄存器，即SP_EL0；当处理器运行在其他异常等级时，处理器可以选择使用SP_EL0或者对应的SP_ELn寄存器 异常掩码标志位 D 调试位。使能该位可以在异常处理过程中打开调试断点和软件单步等功能 A 用来屏蔽系统错误（SError） I 用来屏蔽IRQ F 用来屏蔽FIQ 访问权限 PAN 特权模式禁止访问（Privileged Access Never）位是ARMv8.1的扩展特性 　1：在EL1或者EL2访问属于EL0的虚拟地址时会触发一个访问权限错误 　0：不支持该功能，需要软件来模拟 UAO 用户访问覆盖标志位，是ARMv8.2的扩展特性 　1：当运行在EL1或者EL2时，没有特权的加载存储指令可以和有特权的加载存储指令一样访问内存，如LDTR指令\n　0：不支持该功能 1.3.3 特殊寄存器 ARMv8体系结构除31个通用寄存器外，还提供多个特殊寄存器\n1.零寄存器 ARMv8提供两个零寄存器(zero register)，寄存器内部全是0，WZR是32位零寄存器，XZR是64位零寄存器\n2.PC指针寄存器 PC指针寄存器用来存储当前运行指令的下一条指令地址，控制程序中指令的运行顺序，不可直接访问 3.SP寄存器 ARMv8体系结构支持4个异常等级，每个异常等级有专门SP寄存器：SP_EL0、SP_EL1、SP_EL2、SP_EL3 Linux内核使用SP_EL0存放进程中task_struct数据结构指针\n4.备份状态寄存器 运行异常处理程序时，处理器备份程序会保存备份程序状态寄存器(Savaed Program Status Register SPSR)里。当异常发生时，处理器会把PSTATE寄存器的值暂时保存到SPSR里，当异常处理完成并返回时，再把SPSR值恢复到PSTATE寄存器，SPSR字段：\n字　段 描　述 N 负数标志位 Z 零标志位 C 进位标志位 V 有符号数溢出标志位 DIT 与数据无关的指令时序（Data Independent Timing），ARMv8.4的扩展特性 UAO 用户访问覆盖标志位，ARMv8.2的扩展特性 PAN 特权模式禁止访问位，ARMv8.1的扩展特性 SS 表示是否使能软件单步功能。若该位为1，说明在异常处理中使能了软件单步功能 IL 不合法的异常状态 D 调试位。使能该位可以在异常处理过程中打开调试断点和软件单步等功能 A 用来屏蔽系统错误 I 用来屏蔽IRQ F 用来屏蔽FIQ M[4] 用来表示异常处理过程中处于哪个执行状态，若为0，表示AArch64状态 M[3:0] 异常模式 5. ELR ELR存放异常返回地址\n6.CurrentEL寄存器 该寄存器表示PSTATE寄存器中EL字段，保存异常等级，使用MRS指令读取当前异常等级\n7.DAIF寄存器 该寄存器表示PSTATE寄存器中[D、A、I、F]字段\n8.SPSel寄存器 寄存器表示PSTATE寄存器中SP字段，用于在SP_EL0和SP_ELn中选择SP寄存器\n9.PAN寄存器 PAN寄存器表示PSTATE寄存器中PAN字段，通过MSR和MRS指令设置PAN寄存器\n内核态访问用户态内存，主动调用内核接口，如copy_from_user()或copy_to_user() PAN寄存器值：0：表示内核态可访问用户态内存； 1：表示内核态访问用户态内存会触发访问权限异常\n10.UAO寄存器 该寄存器表示PSTATE寄存器中UAO(User Access Override 用户访问覆盖)字段，MSR和MRS设置UAO寄存器，1表示EL1和EL2执行非特权指令效果和特权指令一样\n11.NZCV寄存器 PSTATE寄存器中{N, Z, C, V}\n1.3.4 系统寄存器 ARMv8体系结构7类系统寄存器 通用系统控制寄存器 调试寄存器 性能监控寄存器 活动监控寄存器 统计扩展寄存器 RAS寄存器 通用定时寄存器 系统寄存器支持不同的异常等级访问，Reg_ELx MSR和MRS指令访问系统寄存器 mrs x0, TTBR0_EL1 // 把TTBR0_EL1值复制到X0寄存器 msr TTBR0_El1, X0 // 把X0寄存器值复制到TTBR0_EL1 1.指令预取单元 指令预取单元从L1指令高速缓存中获取指令，每个周期向译码单元最多发送3条指令。支持动态和静态分支预测，指令预取单元功能：\nL1指令高速缓存是一个48 KB大小、3路组相连的高速缓存，每个缓存行的大小为64字节。 支持48个表项的全相连指令TLB，可以支持4 KB、64 KB以及1 MB大小的页面。 带有分支目标缓冲器的2级动态预测器，用于快速生成目标。 支持静态分支预测。 支持间接预测。 返回栈缓冲器。 2.指令译码单元 指令译码单元对A32、T32、A64指令集进行译码 指令译码单元执行寄存器重命名，消除写后写(WAW)和读后写(WAR)实现乱序执行 3.指令分派单元 指令分派单元控制译码后的指令何时被分派到执行管道及返回的结果何时终止，包括ARM核心通用寄存器、SIMD和浮点寄存器\n4.加载/存储单元 加载/存储单元(LSU)执行加载和存储指令，包括L1数据存储系统\n5.L1内存子系统 L1内存子系统包括指令内存系统和数据内存系统 L1指令内存系统包括如下特性 具有48 KB的指令高速缓存，3路组相连映射。 缓存行的大小为64字节。 支持物理索引物理标记（PIPT）。 高速缓存行的替换算法为LRU（Least Recently Used）算法。 L1数据内存系统包括如下特性 具有32 KB的数据高速缓存，两路组相连映射。 缓存行的大小为64字节。 支持物理索引物理标记。 对于普通内存，支持乱序发射、预测以及非阻塞的加载请求访问；对于设备内存，支持非预测以及非阻塞的加载请求访问。 高速缓存行的替换算法为LRU算法。 支持硬件预取。 6.MMU MMU实现虚拟地址到物理地址转换，AArch64支持4KB、16KB、64KB页面 MMMU包括：\n48表项全相连的L1指令TLB 32表项全相连的L1数据TLB 4路组相连L2 TLB TLB支持8位或16位ASId，还支持VMID(虚拟化)\n7.L2内存子系统 L2内存子系统不仅负责处理每个处理器内核的L1指令和数据高速缓存未命中的情况，还通过ACE或者CHI连接到内存系统。其特性 可配置L2高速缓存的大小，大小可以是512 KB、1 MB、2 MB、4 MB。 缓存行大小为64字节。 支持物理索引物理标记。 具有16路组相连高速缓存。 缓存一致性监听控制单元（Snoop Control Unit，SCU）。 具有可配置的128位宽的ACE或者CHI。 具有可选的128位宽的ACP接口。 支持硬件预取。 1.5 ARMv9体系结构 ARMv9体系结构新加入的特性包括： 全新的可伸缩矢量扩展（Scalable Vector Extension version 2，SVE2）计算； 机密计算体系结构（Confidential Compute Architecture，CCA），基于硬件提供的安全环境来保护用户敏感数据； 分支记录缓冲区扩展（Branch Record Buffer Extension，BRBE），它以低成本的方式捕获控制路径历史的分支记录缓冲区； 内嵌跟踪扩展（Embedded Trace Extension，ETE）以及跟踪缓冲区扩展（Trace Buffer Extension，TRBE），用于增强对ARMv9处理器内核的调试和跟踪功能； 事务内存扩展（Transactional Memory Extension，TME） 第2章 搭建树莓派环境 2.1 树莓派 树莓派4B 博通BCM2711芯片 CPU内核：4核 A72 1.5GHz L1缓存： 32KB数据缓存，48KB指令缓存 L2缓存： 1MB GPU： VideoCoreV1核心，500MHz 内存： LPDDR4 两种地址模式：\n低地址模式 35位全地址模式 2.2 搭建树莓派环境 2.2.2 安装树莓派官方OS boot分区包括文件：\nbootcode.bin：引导程序 start4.elf：树莓派4B的GPU固件 start.elf： 树莓派3B的GPU固件 config.txt：配置文件 2.2.4 使用GDB和QEMU虚拟机调试BenOS 2.3 BenOS代码 2.4 QEMU虚拟机与ARM64 QEMU虚拟机与ARM64实验平台，书中Ubuntu20.04 1)安装工具\nsudo apt-get install qemu-system-arm libncurses5-dev gcc-aarch64-linux-gnu build-essential git bison flex libssl-dev # 查看ARM gcc版本 aarch64-linux-gnu-gcc -v 2)下载仓库\ngit clone git@github.com:figozhang/runninglinuxkernel_5.0.git 3)编译内核及创建文件系统 rootfs_arm64.tar.xz文件基于20.04系统的根文件系统创建\n# 编译内核 cd runninglinuxkernel_5.0 ./run_rlk_arm64.sh build_kernel # 编译文件系统 生成rootfs_arm64.ext4根文件系统 cd runninglinuxkernel_5.0 sudo ./run_rlk_arm64.sh build_rootfs 4)运行ARM64版本Linux系统\n./run_rlk_arm64.sh run # root 123 # 或 qemu-system-aarch64 -m 1024 -cpu max,sve=on,sev256=on -M virts 5)在线安装软件包 # 查看网络配置 ifconfig 6)主机和QEMU虚拟机共享文件 cp test.c runninglinuxkernel_5.0/kmodules/ # qemu cd /mnt ls 第3章 A64指令集I ———— 加载与存储指令 A64指令特点 3.1 A64指令集介绍 ARMv8体系结构，A64指令集64位指令集，处理64位宽寄存器和数据，并使用64位指针访问内存，A64指令集指令宽度为32位 A64指集分类：\n内存加载和存在指令 多字节内存饺子和存储指令 算数和移位指令 移位操作指令 位操作指令 条件操作指令 跳转指令 独占内存访问 内存屏障指令 异常处理指令 系统寄存器访问指令 3.2 A64指令编码 A64指令集指令宽度为32位，第24~28位识别指令分类\nop0字段值\nop0 字段值 说 明 0000x 保留 0010x 可伸缩矢量扩展(SVE)指令 100xx 数据处理指令(立即数) 101xx 分支处理指令、异常处理指令及系统寄存器访问指令 x1x0x 加载与存储指令 x101x 数据处理指令(基于寄存器) x111x 数据处理指令(浮点数与SIMD) 加载与存储指令分类 为什么指令编码宽度是32位？ A64指令集基于寄存器加载和存储体系结构设计，数据加载、存储及处理在通用寄存器中。ARM64一共31个通用寄存器X0~X30，因此在指令编码中使用5位宽，可索引32个通用寄存器 使用寄存器作为基地址，把SP(栈指针)寄存器当做第31个通用寄存器 用作源寄存器操作数时，把XZR当作第31个通用寄存器 3.3 加载与存储指令 参考文档 ARM Architecture Reference Manual Supplement®ARMv8.1, for ARMv8-A architecture profile\nARM Cortex -A Series®®Version: 1.0 Programmer’s Guide for ARMv8-A\nARM® Cortex®-A72 MPCore Processor Revision: r0p3 Technical Reference Manual\n",
  "wordCount" : "5402",
  "inLanguage": "en",
  "datePublished": "2022-07-12T00:21:58+08:00",
  "dateModified": "2022-07-12T00:21:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "Zain"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://liuz0123.gitee.io/zain/posts/tech/arm64%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%BC%96%E7%A8%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "zain's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://liuz0123.gitee.io/zain/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://liuz0123.gitee.io/zain/" accesskey="h" title="Zain&#39;s Blog (Alt + H)">
            <img src="https://liuz0123.gitee.io/zain/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Zain&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://liuz0123.gitee.io/zain/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/archives/" title="⏱ 时间轴">
                <span>⏱ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/links" title="🤝 闲言俗语">
                <span>🤝 闲言俗语</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://liuz0123.gitee.io/zain/">主页</a>&nbsp;»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/tech/">👨🏻‍💻 技术</a></div>
            <h1 class="post-title">
                ARM64体系结构编程与实践
            </h1>
            <div class="post-meta">Create:&nbsp;<span title='2022-07-12 00:21:58 +0800 CST'>2022-07-12</span>&nbsp;|&nbsp;Update:&nbsp;2022-07-12&nbsp;|&nbsp;Words:&nbsp;5402&nbsp;|&nbsp;&nbsp;11 min&nbsp;|&nbsp;
&nbsp;Zain



                &nbsp;|&nbsp;tags: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://liuz0123.gitee.io/zain/tags/arm/">ARM</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| Viewers: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ac%ac1%e7%ab%a0-arm64%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84%e5%9f%ba%e7%a1%80" aria-label="第1章 ARM64体系结构基础">第1章 ARM64体系结构基础</a><ul>
                        
                <li>
                    <a href="#11-arm%e7%ae%80%e4%bb%8b" aria-label="1.1 ARM简介">1.1 ARM简介</a></li>
                <li>
                    <a href="#12-armv8%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" aria-label="1.2 ARMv8体系结构基础知识">1.2 ARMv8体系结构基础知识</a><ul>
                        
                <li>
                    <a href="#121-armv8%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84" aria-label="1.2.1 ARMv8体系结构">1.2.1 ARMv8体系结构</a></li>
                <li>
                    <a href="#122-armv8%e5%a4%84%e7%90%86%e5%99%a8%e5%86%85%e6%a0%b8" aria-label="1.2.2 ARMv8处理器内核">1.2.2 ARMv8处理器内核</a></li>
                <li>
                    <a href="#123-armv8%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" aria-label="1.2.3 ARMv8体系结构基本概念">1.2.3 ARMv8体系结构基本概念</a></li>
                <li>
                    <a href="#124-a64%e6%8c%87%e4%bb%a4%e9%9b%86" aria-label="1.2.4 A64指令集">1.2.4 A64指令集</a></li>
                <li>
                    <a href="#125-armv8%e5%a4%84%e7%90%86%e5%99%a8%e6%89%a7%e8%a1%8c%e7%8a%b6%e6%80%81" aria-label="1.2.5 ARMv8处理器执行状态">1.2.5 ARMv8处理器执行状态</a></li>
                <li>
                    <a href="#126-armv8%e6%95%b0%e6%8d%ae%e5%ae%bd%e5%ba%a6" aria-label="1.2.6 ARMv8数据宽度">1.2.6 ARMv8数据宽度</a></li></ul>
                </li>
                <li>
                    <a href="#13-armv8%e5%af%84%e5%ad%98%e5%99%a8" aria-label="1.3 ARMv8寄存器">1.3 ARMv8寄存器</a><ul>
                        
                <li>
                    <a href="#131-%e9%80%9a%e7%94%a8%e5%af%84%e5%ad%98%e5%99%a8" aria-label="1.3.1 通用寄存器">1.3.1 通用寄存器</a></li>
                <li>
                    <a href="#132-%e5%a4%84%e7%90%86%e5%99%a8%e7%8a%b6%e6%80%81" aria-label="1.3.2 处理器状态">1.3.2 处理器状态</a></li>
                <li>
                    <a href="#133-%e7%89%b9%e6%ae%8a%e5%af%84%e5%ad%98%e5%99%a8" aria-label="1.3.3 特殊寄存器">1.3.3 特殊寄存器</a><ul>
                        
                <li>
                    <a href="#1%e9%9b%b6%e5%af%84%e5%ad%98%e5%99%a8" aria-label="1.零寄存器">1.零寄存器</a></li>
                <li>
                    <a href="#2pc%e6%8c%87%e9%92%88%e5%af%84%e5%ad%98%e5%99%a8" aria-label="2.PC指针寄存器">2.PC指针寄存器</a></li>
                <li>
                    <a href="#3sp%e5%af%84%e5%ad%98%e5%99%a8" aria-label="3.SP寄存器">3.SP寄存器</a></li>
                <li>
                    <a href="#4%e5%a4%87%e4%bb%bd%e7%8a%b6%e6%80%81%e5%af%84%e5%ad%98%e5%99%a8" aria-label="4.备份状态寄存器">4.备份状态寄存器</a></li>
                <li>
                    <a href="#5-elr" aria-label="5. ELR">5. ELR</a></li>
                <li>
                    <a href="#6currentel%e5%af%84%e5%ad%98%e5%99%a8" aria-label="6.CurrentEL寄存器">6.CurrentEL寄存器</a></li>
                <li>
                    <a href="#7daif%e5%af%84%e5%ad%98%e5%99%a8" aria-label="7.DAIF寄存器">7.DAIF寄存器</a></li>
                <li>
                    <a href="#8spsel%e5%af%84%e5%ad%98%e5%99%a8" aria-label="8.SPSel寄存器">8.SPSel寄存器</a></li>
                <li>
                    <a href="#9pan%e5%af%84%e5%ad%98%e5%99%a8" aria-label="9.PAN寄存器">9.PAN寄存器</a></li>
                <li>
                    <a href="#10uao%e5%af%84%e5%ad%98%e5%99%a8" aria-label="10.UAO寄存器">10.UAO寄存器</a></li>
                <li>
                    <a href="#11nzcv%e5%af%84%e5%ad%98%e5%99%a8" aria-label="11.NZCV寄存器">11.NZCV寄存器</a></li></ul>
                </li>
                <li>
                    <a href="#134-%e7%b3%bb%e7%bb%9f%e5%af%84%e5%ad%98%e5%99%a8" aria-label="1.3.4 系统寄存器">1.3.4 系统寄存器</a><ul>
                        
                <li>
                    <a href="#1%e6%8c%87%e4%bb%a4%e9%a2%84%e5%8f%96%e5%8d%95%e5%85%83" aria-label="1.指令预取单元">1.指令预取单元</a></li>
                <li>
                    <a href="#2%e6%8c%87%e4%bb%a4%e8%af%91%e7%a0%81%e5%8d%95%e5%85%83" aria-label="2.指令译码单元">2.指令译码单元</a></li>
                <li>
                    <a href="#3%e6%8c%87%e4%bb%a4%e5%88%86%e6%b4%be%e5%8d%95%e5%85%83" aria-label="3.指令分派单元">3.指令分派单元</a></li>
                <li>
                    <a href="#4%e5%8a%a0%e8%bd%bd%e5%ad%98%e5%82%a8%e5%8d%95%e5%85%83" aria-label="4.加载/存储单元">4.加载/存储单元</a></li>
                <li>
                    <a href="#5l1%e5%86%85%e5%ad%98%e5%ad%90%e7%b3%bb%e7%bb%9f" aria-label="5.L1内存子系统">5.L1内存子系统</a></li>
                <li>
                    <a href="#6mmu" aria-label="6.MMU">6.MMU</a></li>
                <li>
                    <a href="#7l2%e5%86%85%e5%ad%98%e5%ad%90%e7%b3%bb%e7%bb%9f" aria-label="7.L2内存子系统">7.L2内存子系统</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#15-armv9%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84" aria-label="1.5 ARMv9体系结构">1.5 ARMv9体系结构</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac2%e7%ab%a0-%e6%90%ad%e5%bb%ba%e6%a0%91%e8%8e%93%e6%b4%be%e7%8e%af%e5%a2%83" aria-label="第2章 搭建树莓派环境">第2章 搭建树莓派环境</a><ul>
                        
                <li>
                    <a href="#21-%e6%a0%91%e8%8e%93%e6%b4%be" aria-label="2.1 树莓派">2.1 树莓派</a></li>
                <li>
                    <a href="#22-%e6%90%ad%e5%bb%ba%e6%a0%91%e8%8e%93%e6%b4%be%e7%8e%af%e5%a2%83" aria-label="2.2 搭建树莓派环境">2.2 搭建树莓派环境</a><ul>
                        
                <li>
                    <a href="#222-%e5%ae%89%e8%a3%85%e6%a0%91%e8%8e%93%e6%b4%be%e5%ae%98%e6%96%b9os" aria-label="2.2.2 安装树莓派官方OS">2.2.2 安装树莓派官方OS</a></li>
                <li>
                    <a href="#224-%e4%bd%bf%e7%94%a8gdb%e5%92%8cqemu%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%b0%83%e8%af%95benos" aria-label="2.2.4 使用GDB和QEMU虚拟机调试BenOS">2.2.4 使用GDB和QEMU虚拟机调试BenOS</a></li></ul>
                </li>
                <li>
                    <a href="#23-benos%e4%bb%a3%e7%a0%81" aria-label="2.3 BenOS代码">2.3 BenOS代码</a></li>
                <li>
                    <a href="#24-qemu%e8%99%9a%e6%8b%9f%e6%9c%ba%e4%b8%8earm64" aria-label="2.4 QEMU虚拟机与ARM64">2.4 QEMU虚拟机与ARM64</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac3%e7%ab%a0-a64%e6%8c%87%e4%bb%a4%e9%9b%86i--%e5%8a%a0%e8%bd%bd%e4%b8%8e%e5%ad%98%e5%82%a8%e6%8c%87%e4%bb%a4" aria-label="第3章 A64指令集I ———— 加载与存储指令">第3章 A64指令集I ———— 加载与存储指令</a><ul>
                        
                <li>
                    <a href="#31-a64%e6%8c%87%e4%bb%a4%e9%9b%86%e4%bb%8b%e7%bb%8d" aria-label="3.1 A64指令集介绍">3.1 A64指令集介绍</a></li>
                <li>
                    <a href="#32-a64%e6%8c%87%e4%bb%a4%e7%bc%96%e7%a0%81" aria-label="3.2 A64指令编码">3.2 A64指令编码</a></li>
                <li>
                    <a href="#33-%e5%8a%a0%e8%bd%bd%e4%b8%8e%e5%ad%98%e5%82%a8%e6%8c%87%e4%bb%a4" aria-label="3.3 加载与存储指令">3.3 加载与存储指令</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e6%96%87%e6%a1%a3" aria-label="参考文档">参考文档</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="第1章-arm64体系结构基础">第1章 ARM64体系结构基础<a hidden class="anchor" aria-hidden="true" href="#第1章-arm64体系结构基础">#</a></h1>
<ul>
<li>ARMv8体系结构处理器包含<code>31</code>个通用寄存器</li>
<li>AArch64执行状态包含·<code>4</code>个异常等级，EL0~EL3，用户态、内核态、虚拟机、安全态</li>
<li>PSTATE寄存器中NZCV标志：负零进溢</li>
<li>PSTATE寄存器DAIF异常掩码标志位</li>
</ul>
<h2 id="11-arm简介">1.1 ARM简介<a hidden class="anchor" aria-hidden="true" href="#11-arm简介">#</a></h2>
<p> ARM体系结构是一种硬件规范，主要约定指令集、芯片内部体系结构  <br>
 ARMv8体系结构处理器IP Cortex-A53、Cortex-A55、Cortex-A72、Cortex-A77  <br></p>
<h2 id="12-armv8体系结构基础知识">1.2 ARMv8体系结构基础知识<a hidden class="anchor" aria-hidden="true" href="#12-armv8体系结构基础知识">#</a></h2>
<h3 id="121-armv8体系结构">1.2.1 ARMv8体系结构<a hidden class="anchor" aria-hidden="true" href="#121-armv8体系结构">#</a></h3>
<p> ARMv8是64位处理器指令集和体系结构  <br></p>
<ul>
<li>64位虚拟地址空间，32位仅支持4GB</li>
<li>31个64位宽通用寄存器</li>
<li>支持16KB和64Kb页面，降低TLB命中率</li>
<li>异常处理模型EL0~EL3</li>
<li>加载-获取指令(Load-Acquire Instruction)，存储-释放指令(Store-Release Instruction)</li>
</ul>
<h3 id="122-armv8处理器内核">1.2.2 ARMv8处理器内核<a hidden class="anchor" aria-hidden="true" href="#122-armv8处理器内核">#</a></h3>
<ul>
<li>Cortex-A53</li>
<li>Cortex-A57</li>
<li>Cortex-A72</li>
</ul>
<h3 id="123-armv8体系结构基本概念">1.2.3 ARMv8体系结构基本概念<a hidden class="anchor" aria-hidden="true" href="#123-armv8体系结构基本概念">#</a></h3>
<p> ARMv8体系结构基本概念和定义  <br></p>
<ul>
<li>处理机PE(Processing Element):处理器处理事务过程抽象</li>
<li>执行状态(execution state):处理器运行时环境，包括寄存器位宽、支持指令集、异常模型、内存管理以及编程模型  <br></li>
</ul>
<blockquote>
<p>ARMv8两个执行状态</p>
<blockquote>
<p>AArch64：64位执行状态</p>
<blockquote>
<p>31个通用寄存器
64位程序计数(PC)指针寄存器、栈指针(Stack Pointer SP)寄存器及异常链接寄存器(Exception Link Register ELR)
A64指令集
ARMv8异常模型，4个异常等级，即EL0~EL3
64位内存模型
一组处理器状态(PSTATE)保存PE状态
AArch32: 32位执行状态</p>
</blockquote>
</blockquote>
</blockquote>
<p> AArch64状态，部分系统寄存器在不同异常等级提供不同变种寄存器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>register_name<span style="color:#f92672">&gt;</span>_ELx  <span style="color:#75715e">// x: 0 1 2 3
</span></span></span></code></pre></div><h3 id="124-a64指令集">1.2.4 A64指令集<a hidden class="anchor" aria-hidden="true" href="#124-a64指令集">#</a></h3>
<p> ARMv8体系结构64位指令集：处理64位宽寄存器和数据并使用64位指针访问内存</p>
<h3 id="125-armv8处理器执行状态">1.2.5 ARMv8处理器执行状态<a hidden class="anchor" aria-hidden="true" href="#125-armv8处理器执行状态">#</a></h3>
<p> AArch64状态异常等级(exception level)确定处理器当前运行的特权级别</p>
<ul>
<li>EL0:用户特权</li>
<li>EL1：系统特权，操作系统内核，系统使能虚拟化扩展，运行虚拟操作系统内核</li>
<li>EL2：运行虚拟化扩展的虚拟监控程序(hypervisor)</li>
<li>EL3：运行安全世界中安全监控器(secure monitor)</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221204150429.png" alt="20221204150429"  />
</p>
<h3 id="126-armv8数据宽度">1.2.6 ARMv8数据宽度<a hidden class="anchor" aria-hidden="true" href="#126-armv8数据宽度">#</a></h3>
<ul>
<li>字节(byte)：8位</li>
<li>半字(halfword)：16位</li>
<li>字(word)：32位</li>
<li>双字(doubleword)：64位</li>
<li>四字(quadword)：128位</li>
</ul>
<h2 id="13-armv8寄存器">1.3 ARMv8寄存器<a hidden class="anchor" aria-hidden="true" href="#13-armv8寄存器">#</a></h2>
<h3 id="131-通用寄存器">1.3.1 通用寄存器<a hidden class="anchor" aria-hidden="true" href="#131-通用寄存器">#</a></h3>
<p> AArch64执行状态支持31个64位通用寄存器，X0~X30寄存器，AArch32状态支持16个32位通用寄存器  <br>
 AArch64状态下，X表示64位通用寄存器，W表示低32位的数据</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221204151151.png" alt="20221204151151"  />
</p>
<h3 id="132-处理器状态">1.3.2 处理器状态<a hidden class="anchor" aria-hidden="true" href="#132-处理器状态">#</a></h3>
<p> AArch64体系结构使用PSTATE寄存器表示当前处理器状态</p>
<table>
	<tr>
	    <th>分　　类</th>
	    <th>字　　段</th>
	    <th>描　　述</th>  
	    <th>描　　述</th>  
	</tr >
	<tr >
	    <td rowspan="4">条件标志位</td>
	    <td>N</td>
	    <td>负数标志位。
在结果是有符号的二进制补码的情况下，如果结果为负数，则N=1；如果结果为非负数，则N=0</td>
	</tr>
	<tr>
	    <td>Z</td>
	    <td>0标志位。如果结果为0，则Z=1；如果结果不为0，则Z=0</td>
	</tr>
    <tr>
	    <td>C</td>
	    <td>进位标志位。当发生无符号数溢出时，C=1。其他情况下，C=0</td>
	</tr>
    <tr>
	    <td>V</td>
	    <td>有符号数溢出标志位。<br>　对于加/减法指令，在操作数和结果是有符号的整数时，如果发生溢出，则V=1；如果未发生溢出，则V=0。<br>　对于其他指令，V通常不发生变化</td>
	</tr>
    <tr >
	    <td rowspan="3">执行状态控制</td>
	    <td>SS</td>
	    <td>软件单步。该位为1，说明在异常处理中使能了软件单步功能</td>
	</tr>
    <tr>
	    <td>IL</td>
	    <td>不合法的异常状态</td>
	</tr>
    <tr>
	    <td>nRW</td>
	    <td>当前执行状态 <br>　0：处于AArch64状态 <br>　1：处于AArch32状态</td>
	</tr>
    <tr >
	    <td rowspan="2">执行状态控制</td>
	    <td>EL</td>
	    <td>当前异常等级 <br> 　0：表示EL0<br> 　1：表示EL1<br> 　2：表示EL2<br> 　3：表示EL3</td>
	</tr>
    <tr>
	    <td>SP</td>
	    <td>选择SP寄存器。当运行在EL0时，处理器选择EL0的SP寄存器，即SP_EL0；当处理器运行在其他异常等级时，处理器可以选择使用SP_EL0或者对应的SP_ELn寄存器</td>
	</tr>
    <tr >
	    <td rowspan="4">异常掩码标志位</td>
	    <td>D</td>
	    <td>调试位。使能该位可以在异常处理过程中打开调试断点和软件单步等功能</td>
	</tr>
    <tr>
	    <td>A</td>
	    <td>用来屏蔽系统错误（SError）</td>
	</tr>
    <tr>
	    <td>I</td>
	    <td>用来屏蔽IRQ</td>
	</tr>
    <tr>
	    <td>F</td>
	    <td>用来屏蔽FIQ</td>
	</tr>
    <tr >
	    <td rowspan="2">访问权限</td>
	    <td>PAN</td>
	    <td>特权模式禁止访问（Privileged Access Never）位是ARMv8.1的扩展特性 <br> 　1：在EL1或者EL2访问属于EL0的虚拟地址时会触发一个访问权限错误 <br> 　0：不支持该功能，需要软件来模拟</td>
	</tr>
    <tr>
	    <td>UAO</td>
	    <td>用户访问覆盖标志位，是ARMv8.2的扩展特性 <br> 　1：当运行在EL1或者EL2时，没有特权的加载存储指令可以和有特权的加载存储指令一样访问内存，如LDTR指令<br>　0：不支持该功能</td>
	</tr>
</table>
<h3 id="133-特殊寄存器">1.3.3 特殊寄存器<a hidden class="anchor" aria-hidden="true" href="#133-特殊寄存器">#</a></h3>
<p> ARMv8体系结构除31个通用寄存器外，还提供多个特殊寄存器</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221204153018.png" alt="20221204153018"  />
</p>
<h4 id="1零寄存器">1.零寄存器<a hidden class="anchor" aria-hidden="true" href="#1零寄存器">#</a></h4>
<p> ARMv8提供两个零寄存器(zero register)，寄存器内部全是0，WZR是32位零寄存器，XZR是64位零寄存器</p>
<h4 id="2pc指针寄存器">2.PC指针寄存器<a hidden class="anchor" aria-hidden="true" href="#2pc指针寄存器">#</a></h4>
<p> PC指针寄存器用来存储当前运行指令的<code>下一条指令地址</code>，控制程序中指令的运行顺序，不可直接访问  <br></p>
<h4 id="3sp寄存器">3.SP寄存器<a hidden class="anchor" aria-hidden="true" href="#3sp寄存器">#</a></h4>
<p> ARMv8体系结构支持4个异常等级，每个异常等级有专门SP寄存器：SP_EL0、SP_EL1、SP_EL2、SP_EL3  <br>
 Linux内核使用SP_EL0存放进程中<code>task_struct</code>数据结构指针</p>
<h4 id="4备份状态寄存器">4.备份状态寄存器<a hidden class="anchor" aria-hidden="true" href="#4备份状态寄存器">#</a></h4>
<p> 运行异常处理程序时，处理器备份程序会保存备份程序状态寄存器(Savaed Program Status Register SPSR)里。当异常发生时，处理器会把PSTATE寄存器的值暂时保存到SPSR里，当异常处理完成并返回时，再把SPSR值恢复到PSTATE寄存器，SPSR字段：</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221204172503.png" alt="20221204172503"  />
</p>
<table>
	<tr>
	    <th>字　　段</th>
	    <th>描　　述</th>
	</tr >
	<tr >
	    <td>N</td>
	    <td>负数标志位</td>
	</tr>
    <tr >
	    <td>Z</td>
	    <td>零标志位</td>
	</tr>
    <tr >
	    <td>C</td>
	    <td>进位标志位</td>
	</tr>
    <tr >
	    <td>V</td>
	    <td>有符号数溢出标志位</td>
	</tr>
    <tr >
	    <td>DIT</td>
	    <td>与数据无关的指令时序（Data Independent Timing），ARMv8.4的扩展特性</td>
	</tr>
    <tr >
	    <td>UAO</td>
	    <td>用户访问覆盖标志位，ARMv8.2的扩展特性</td>
	</tr>
     <tr >
	    <td>PAN</td>
	    <td>特权模式禁止访问位，ARMv8.1的扩展特性</td>
	</tr>
     <tr >
	    <td>SS</td>
	    <td>表示是否使能软件单步功能。若该位为1，说明在异常处理中使能了软件单步功能</td>
	</tr>
     <tr >
	    <td>IL</td>
	    <td>不合法的异常状态</td>
	</tr>
     <tr >
	    <td>D</td>
	    <td>调试位。使能该位可以在异常处理过程中打开调试断点和软件单步等功能</td>
	</tr>
     <tr >
	    <td>A</td>
	    <td>用来屏蔽系统错误</td>
	</tr>
     <tr >
	    <td>I</td>
	    <td>用来屏蔽IRQ</td>
	</tr>
     <tr >
	    <td>F</td>
	    <td>用来屏蔽FIQ</td>
	</tr>
     <tr >
	    <td>M[4]</td>
	    <td>用来表示异常处理过程中处于哪个执行状态，若为0，表示AArch64状态</td>
	</tr>
     <tr >
	    <td>M[3:0]</td>
	    <td>异常模式</td>
	</tr>
</table>
<h4 id="5-elr">5. ELR<a hidden class="anchor" aria-hidden="true" href="#5-elr">#</a></h4>
<p> ELR存放异常返回地址</p>
<h4 id="6currentel寄存器">6.CurrentEL寄存器<a hidden class="anchor" aria-hidden="true" href="#6currentel寄存器">#</a></h4>
<p> 该寄存器表示PSTATE寄存器中EL字段，保存异常等级，使用MRS指令读取当前异常等级</p>
<h4 id="7daif寄存器">7.DAIF寄存器<a hidden class="anchor" aria-hidden="true" href="#7daif寄存器">#</a></h4>
<p> 该寄存器表示PSTATE寄存器中[D、A、I、F]字段</p>
<h4 id="8spsel寄存器">8.SPSel寄存器<a hidden class="anchor" aria-hidden="true" href="#8spsel寄存器">#</a></h4>
<p> 寄存器表示PSTATE寄存器中SP字段，用于在SP_EL0和SP_ELn中选择SP寄存器</p>
<h4 id="9pan寄存器">9.PAN寄存器<a hidden class="anchor" aria-hidden="true" href="#9pan寄存器">#</a></h4>
<p> PAN寄存器表示PSTATE寄存器中PAN字段，通过MSR和MRS指令设置PAN寄存器<br>
 内核态访问用户态内存，主动调用内核接口，如copy_from_user()或copy_to_user()  <br></p>
<p> PAN寄存器值：0：表示内核态可访问用户态内存； 1：表示内核态访问用户态内存会触发访问权限异常</p>
<h4 id="10uao寄存器">10.UAO寄存器<a hidden class="anchor" aria-hidden="true" href="#10uao寄存器">#</a></h4>
<p> 该寄存器表示PSTATE寄存器中UAO(User Access Override 用户访问覆盖)字段，MSR和MRS设置UAO寄存器，1表示EL1和EL2执行非特权指令效果和特权指令一样</p>
<h4 id="11nzcv寄存器">11.NZCV寄存器<a hidden class="anchor" aria-hidden="true" href="#11nzcv寄存器">#</a></h4>
<p> PSTATE寄存器中{N, Z, C, V}</p>
<h3 id="134-系统寄存器">1.3.4 系统寄存器<a hidden class="anchor" aria-hidden="true" href="#134-系统寄存器">#</a></h3>
<p> ARMv8体系结构7类系统寄存器  <br></p>
<ul>
<li>通用系统控制寄存器</li>
<li>调试寄存器</li>
<li>性能监控寄存器</li>
<li>活动监控寄存器</li>
<li>统计扩展寄存器</li>
<li>RAS寄存器</li>
<li>通用定时寄存器</li>
</ul>
<p> 系统寄存器支持不同的异常等级访问，Reg_ELx  <br>
 MSR和MRS指令访问系统寄存器  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mrs x0, TTBR0_EL1   <span style="color:#75715e">// 把TTBR0_EL1值复制到X0寄存器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>msr TTBR0_El1, X0   <span style="color:#75715e">// 把X0寄存器值复制到TTBR0_EL1
</span></span></span></code></pre></div><h4 id="1指令预取单元">1.指令预取单元<a hidden class="anchor" aria-hidden="true" href="#1指令预取单元">#</a></h4>
<p> 指令预取单元从L1指令高速缓存中获取指令，每个周期向译码单元最多发送3条指令。支持动态和静态分支预测，指令预取单元功能：</p>
<ul>
<li>L1指令高速缓存是一个48 KB大小、3路组相连的高速缓存，每个缓存行的大小为64字节。</li>
<li>支持48个表项的全相连指令TLB，可以支持4 KB、64 KB以及1 MB大小的页面。</li>
<li>带有分支目标缓冲器的2级动态预测器，用于快速生成目标。</li>
<li>支持静态分支预测。</li>
<li>支持间接预测。</li>
<li>返回栈缓冲器。</li>
</ul>
<h4 id="2指令译码单元">2.指令译码单元<a hidden class="anchor" aria-hidden="true" href="#2指令译码单元">#</a></h4>
<p> 指令译码单元对A32、T32、A64指令集进行译码   <br>
 指令译码单元执行寄存器重命名，消除写后写(WAW)和读后写(WAR)实现乱序执行   <br></p>
<h4 id="3指令分派单元">3.指令分派单元<a hidden class="anchor" aria-hidden="true" href="#3指令分派单元">#</a></h4>
<p> 指令分派单元控制译码后的指令何时被分派到执行管道及返回的结果何时终止，包括ARM核心通用寄存器、SIMD和浮点寄存器</p>
<h4 id="4加载存储单元">4.加载/存储单元<a hidden class="anchor" aria-hidden="true" href="#4加载存储单元">#</a></h4>
<p> 加载/存储单元(LSU)执行加载和存储指令，包括L1数据存储系统</p>
<h4 id="5l1内存子系统">5.L1内存子系统<a hidden class="anchor" aria-hidden="true" href="#5l1内存子系统">#</a></h4>
<p> L1内存子系统包括指令内存系统和数据内存系统  <br>
 L1指令内存系统包括如下特性  <br></p>
<ul>
<li>具有48 KB的指令高速缓存，3路组相连映射。</li>
<li>缓存行的大小为64字节。</li>
<li>支持物理索引物理标记（PIPT）。</li>
<li>高速缓存行的替换算法为LRU（Least Recently Used）算法。</li>
</ul>
<p> L1数据内存系统包括如下特性  <br></p>
<ul>
<li>具有32 KB的数据高速缓存，两路组相连映射。</li>
<li>缓存行的大小为64字节。</li>
<li>支持物理索引物理标记。</li>
<li>对于普通内存，支持乱序发射、预测以及非阻塞的加载请求访问；对于设备内存，支持非预测以及非阻塞的加载请求访问。</li>
<li>高速缓存行的替换算法为LRU算法。</li>
<li>支持硬件预取。</li>
</ul>
<h4 id="6mmu">6.MMU<a hidden class="anchor" aria-hidden="true" href="#6mmu">#</a></h4>
<p> MMU实现虚拟地址到物理地址转换，AArch64支持4KB、16KB、64KB页面  <br>
 MMMU包括：</p>
<ul>
<li>48表项全相连的L1指令TLB</li>
<li>32表项全相连的L1数据TLB</li>
<li>4路组相连L2 TLB</li>
</ul>
<p> TLB支持8位或16位ASId，还支持VMID(虚拟化)</p>
<h4 id="7l2内存子系统">7.L2内存子系统<a hidden class="anchor" aria-hidden="true" href="#7l2内存子系统">#</a></h4>
<p> L2内存子系统不仅负责处理每个处理器内核的L1指令和数据高速缓存未命中的情况，还通过ACE或者CHI连接到内存系统。其特性  <br></p>
<ul>
<li>可配置L2高速缓存的大小，大小可以是512 KB、1 MB、2 MB、4 MB。</li>
<li>缓存行大小为64字节。</li>
<li>支持物理索引物理标记。</li>
<li>具有16路组相连高速缓存。</li>
<li>缓存一致性监听控制单元（Snoop Control Unit，SCU）。</li>
<li>具有可配置的128位宽的ACE或者CHI。</li>
<li>具有可选的128位宽的ACP接口。</li>
<li>支持硬件预取。</li>
</ul>
<h2 id="15-armv9体系结构">1.5 ARMv9体系结构<a hidden class="anchor" aria-hidden="true" href="#15-armv9体系结构">#</a></h2>
<p> ARMv9体系结构新加入的特性包括：  <br></p>
<ul>
<li>全新的可伸缩矢量扩展（Scalable Vector Extension version 2，SVE2）计算；</li>
<li>机密计算体系结构（Confidential Compute Architecture，CCA），基于硬件提供的安全环境来保护用户敏感数据；</li>
<li>分支记录缓冲区扩展（Branch Record Buffer Extension，BRBE），它以低成本的方式捕获控制路径历史的分支记录缓冲区；</li>
<li>内嵌跟踪扩展（Embedded Trace Extension，ETE）以及跟踪缓冲区扩展（Trace Buffer Extension，TRBE），用于增强对ARMv9处理器内核的调试和跟踪功能；</li>
<li>事务内存扩展（Transactional Memory Extension，TME）</li>
</ul>
<h1 id="第2章-搭建树莓派环境">第2章 搭建树莓派环境<a hidden class="anchor" aria-hidden="true" href="#第2章-搭建树莓派环境">#</a></h1>
<h2 id="21-树莓派">2.1 树莓派<a hidden class="anchor" aria-hidden="true" href="#21-树莓派">#</a></h2>
<p> 树莓派4B 博通BCM2711芯片  <br></p>
<ul>
<li>CPU内核：4核 A72 1.5GHz</li>
<li>L1缓存： 32KB数据缓存，48KB指令缓存</li>
<li>L2缓存： 1MB</li>
<li>GPU： VideoCoreV1核心，500MHz</li>
<li>内存： LPDDR4</li>
</ul>
<p> 两种地址模式：</p>
<ul>
<li>低地址模式</li>
<li>35位全地址模式</li>
</ul>
<h2 id="22-搭建树莓派环境">2.2 搭建树莓派环境<a hidden class="anchor" aria-hidden="true" href="#22-搭建树莓派环境">#</a></h2>
<h3 id="222-安装树莓派官方os">2.2.2 安装树莓派官方OS<a hidden class="anchor" aria-hidden="true" href="#222-安装树莓派官方os">#</a></h3>
<p> boot分区包括文件：</p>
<ul>
<li>bootcode.bin：引导程序</li>
<li>start4.elf：树莓派4B的GPU固件</li>
<li>start.elf： 树莓派3B的GPU固件</li>
<li>config.txt：配置文件</li>
</ul>
<h3 id="224-使用gdb和qemu虚拟机调试benos">2.2.4 使用GDB和QEMU虚拟机调试BenOS<a hidden class="anchor" aria-hidden="true" href="#224-使用gdb和qemu虚拟机调试benos">#</a></h3>
<h2 id="23-benos代码">2.3 BenOS代码<a hidden class="anchor" aria-hidden="true" href="#23-benos代码">#</a></h2>
<h2 id="24-qemu虚拟机与arm64">2.4 QEMU虚拟机与ARM64<a hidden class="anchor" aria-hidden="true" href="#24-qemu虚拟机与arm64">#</a></h2>
<p> QEMU虚拟机与ARM64实验平台，书中Ubuntu20.04  <br>
 1)安装工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt-get install qemu-system-arm libncurses5-dev gcc-aarch64-linux-gnu build-essential git bison flex libssl-dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看ARM gcc版本</span>
</span></span><span style="display:flex;"><span>aarch64-linux-gnu-gcc -v
</span></span></code></pre></div><p> 2)下载仓库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone git@github.com:figozhang/runninglinuxkernel_5.0.git
</span></span></code></pre></div><p> 3)编译内核及创建文件系统 <br>
 rootfs_arm64.tar.xz文件基于20.04系统的根文件系统创建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 编译内核</span>
</span></span><span style="display:flex;"><span>cd runninglinuxkernel_5.0
</span></span><span style="display:flex;"><span>./run_rlk_arm64.sh build_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译文件系统  生成rootfs_arm64.ext4根文件系统</span>
</span></span><span style="display:flex;"><span>cd runninglinuxkernel_5.0
</span></span><span style="display:flex;"><span>sudo ./run_rlk_arm64.sh build_rootfs
</span></span></code></pre></div><p> 4)运行ARM64版本Linux系统</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./run_rlk_arm64.sh run
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root   123</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 或</span>
</span></span><span style="display:flex;"><span>qemu-system-aarch64 -m <span style="color:#ae81ff">1024</span> -cpu max,sve<span style="color:#f92672">=</span>on,sev256<span style="color:#f92672">=</span>on -M virts
</span></span></code></pre></div><p> 5)在线安装软件包  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 查看网络配置</span>
</span></span><span style="display:flex;"><span>ifconfig 
</span></span></code></pre></div><p> 6)主机和QEMU虚拟机共享文件  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cp test.c runninglinuxkernel_5.0/kmodules/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># qemu</span>
</span></span><span style="display:flex;"><span>cd /mnt
</span></span><span style="display:flex;"><span>ls
</span></span></code></pre></div><h1 id="第3章-a64指令集i--加载与存储指令">第3章 A64指令集I ———— 加载与存储指令<a hidden class="anchor" aria-hidden="true" href="#第3章-a64指令集i--加载与存储指令">#</a></h1>
<p> A64指令特点  <br></p>
<h2 id="31-a64指令集介绍">3.1 A64指令集介绍<a hidden class="anchor" aria-hidden="true" href="#31-a64指令集介绍">#</a></h2>
<p> ARMv8体系结构，A64指令集64位指令集，处理64位宽寄存器和数据，并使用64位指针访问内存，A64指令集指令宽度为32位  <br>
 A64指集分类：</p>
<ul>
<li>内存加载和存在指令</li>
<li>多字节内存饺子和存储指令</li>
<li>算数和移位指令</li>
<li>移位操作指令</li>
<li>位操作指令</li>
<li>条件操作指令</li>
<li>跳转指令</li>
<li>独占内存访问</li>
<li>内存屏障指令</li>
<li>异常处理指令</li>
<li>系统寄存器访问指令</li>
</ul>
<h2 id="32-a64指令编码">3.2 A64指令编码<a hidden class="anchor" aria-hidden="true" href="#32-a64指令编码">#</a></h2>
<p> A64指令集指令宽度为32位，第24~28位识别指令分类</p>
<p> op0字段值</p>
<table>
	<tr>
	    <th>op0 字段值</th>
	    <th>说    明</th>
	</tr>
	<tr>
	    <td>0000x</td>
	    <td>保留</td>
    </tr>
    <tr>
	    <td>0010x</td>
	    <td>可伸缩矢量扩展(SVE)指令</td>
    </tr>
    <tr>
	    <td>100xx</td>
	    <td>数据处理指令(立即数)</td>
    </tr>
    <tr>
	    <td>101xx</td>
	    <td>分支处理指令、异常处理指令及系统寄存器访问指令</td>
    </tr>
    <tr>
	    <td>x1x0x</td>
	    <td>加载与存储指令</td>
    </tr>
    <tr>
	    <td>x101x</td>
	    <td>数据处理指令(基于寄存器)</td>
    </tr>
    <tr>
	    <td>x111x</td>
	    <td>数据处理指令(浮点数与SIMD)</td>
    </tr>
</table>
<p> 加载与存储指令分类  <br></p>
<p> 为什么指令编码宽度是32位？  <br>
 A64指令集基于寄存器加载和存储体系结构设计，数据加载、存储及处理在通用寄存器中。ARM64一共31个通用寄存器X0~X30，因此在指令编码中使用5位宽，可索引32个通用寄存器  <br></p>
<ul>
<li>使用寄存器作为基地址，把SP(栈指针)寄存器当做第31个通用寄存器</li>
<li>用作源寄存器操作数时，把XZR当作第31个通用寄存器</li>
</ul>
<h2 id="33-加载与存储指令">3.3 加载与存储指令<a hidden class="anchor" aria-hidden="true" href="#33-加载与存储指令">#</a></h2>
<h1 id="参考文档">参考文档<a hidden class="anchor" aria-hidden="true" href="#参考文档">#</a></h1>
<p><a href="https://developer.arm.com/documentation/ddi0557/ab?lang=en">ARM Architecture Reference Manual Supplement®ARMv8.1, for ARMv8-A architecture profile</a></p>
<p><a href="https://developer.arm.com/documentation/den0024/a/?lang=en">ARM Cortex -A Series®®Version: 1.0 Programmer’s Guide for ARMv8-A</a></p>
<p><a href="https://developer.arm.com/documentation/100095/0003/?lang=en">ARM® Cortex®-A72 MPCore Processor Revision: r0p3 Technical Reference Manual</a></p>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://liuz0123.gitee.io/zain/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>微信</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://liuz0123.gitee.io/zain/img/alipay.jpg" alt="alipay"></a>
                        <p>支付宝</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>🧧 鼓励</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://liuz0123.gitee.io/zain/posts/tech/mit-6.s081%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
    <span class="title">« 上一页</span>
    <br>
    <span>MIT 6.S081操作系统</span>
  </a>
  <a class="next" href="https://liuz0123.gitee.io/zain/posts/blog/linuxcommand/">
    <span class="title">下一页 »</span>
    <br>
    <span>LinuxCommand</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">💬评论</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://twikoo.js.org/quick-start.html#%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou', 
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://liuz0123.gitee.io/zain/" style="color:#939393;">zain&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">备案号申请中</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="填自己的公安图标链接" style="float:left;margin: 0px 5px 0px 0px;"/>
             公网安备
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        总访客数: <span id="busuanzi_value_site_uv"></span>
        总访问量: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"zain's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"zain's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"zain's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
